

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  clerkId      String    @unique
  email        String    @unique
  name         String?
  role         Role      @default(STUDENT)
  university   String?   // e.g., "KNUST", "UG"
  
  // Vendor-specific fields
  shopName       String?
  shopLandmark   String?
  vendorStatus   VendorStatus @default(NOT_APPLICABLE)
  isAcceptingOrders Boolean   @default(true)
  phoneNumber    String?
  
  // Runner Mode fields
  isRunner     Boolean   @default(false)
  runnerStatus String    @default("OFFLINE") // OFFLINE, ONLINE, BUSY
  xp           Int       @default(0)
  runnerLevel  Int       @default(1)
  
  // Location tracking (hotspot-based)
  currentHotspot String? // e.g., "Balme Library", "Night Market", "Pent Hostel"
  lastActive     DateTime @default(now())
  
  onboarded     Boolean   @default(false)
  appliedForVendor Boolean @default(false)  // Track if user has applied to become vendor
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  products     Product[]
  orderGroups  OrderGroup[] @relation("StudentOrderGroups")
  orders       Order[]   @relation("StudentOrders")
  deliveries   Order[]   @relation("RunnerDeliveries")
  vendorOrders Order[]   @relation("VendorOrders")
  stories      Story[]   @relation("VendorStories")
  payoutRequests PayoutRequest[]
  storyLikes   StoryLike[] @relation("UserStoryLikes")
  storyFavorites StoryFavorite[] @relation("UserStoryFavorites")
  missions     Mission[]
  
  // Financials
  balance      Float     @default(0.0)
  walletFrozen Boolean   @default(false) // Emergency freeze by admin
  frozenBalance Float    @default(0.0)   // Stores balance while frozen

  // Admin Actions
  banned       Boolean   @default(false)
  banReason    String?   // Why user was banned
  
  // Security & Authentication
  has2FA               Boolean   @default(false)
  twoFactorSecret      String?   // Encrypted TOTP secret
  hasBiometric         Boolean   @default(false)
  faceDescriptor       Json?     // Stores face recognition data
  lastSecurityCheck    DateTime  @default(now())
  securitySetupComplete Boolean  @default(false)
  mfaBackupCodes       String[]  @default([]) // Encrypted backup codes
  
  application  VendorApplication?
}

model PayoutRequest {
  id          String   @id @default(uuid())
  amount      Float
  status      String   @default("PENDING") // PENDING, PROCESSED, REJECTED
  momoNumber  String
  network     String   // MTN, VODA, AT
  
  vendorId    String
  vendor      User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  processedAt DateTime?
  
  @@index([vendorId])
  @@index([status])
}

enum Role {
  STUDENT
  VENDOR
  ADMIN
  GOD_MODE
}

enum VendorStatus {
  NOT_APPLICABLE
  PENDING
  ACTIVE
  SUSPENDED
}

model Product {
  id          String   @id @default(uuid())
  title       String
  description String
  price       Float
  
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  
  details     Json?    // For dynamic fields like "spicyLevel", "condition", etc.

  imageUrl    String?  // Primary Cover Image (compatibility)
  images      String[] @default([]) // Gallery Images (NEW)
  
  // Hotspot-based location for Flash-Match
  hotspot     String?  // e.g., "Bush Canteen", "Balme Library"
  
  // Stock Management (NEW)
  stockQuantity     Int      @default(0)
  lowStockThreshold Int      @default(5)
  isInStock         Boolean  @default(true)
  
  // Ratings & Reviews (NEW)
  averageRating     Float?
  totalReviews      Int      @default(0)
  
  // Analytics (NEW)
  viewCount         Int      @default(0)
  salesCount        Int      @default(0)
  
  vendorId    String
  vendor      User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  orderItems  OrderItem[]
  reviews     Review[]
  flashSale   FlashSale?
  
  @@index([vendorId])
  @@index([categoryId])
  @@index([isInStock])
}

// Flash Sales Model (NEW)
model FlashSale {
  id              String   @id @default(uuid())
  name            String   // "Weekend Tech Deals"
  
  productId       String   @unique
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  originalPrice   Float
  salePrice       Float
  discountPercent Int
  
  startTime       DateTime
  endTime         DateTime
  
  stockLimit      Int      // Max items for this sale
  stockSold       Int      @default(0)
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([isActive])
  @@index([endTime])
}

// Product Reviews Model (NEW)
model Review {
  id               String   @id @default(uuid())
  
  productId        String
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  userId           String
  userName         String   // Cached for display
  
  rating           Int      // 1-5 stars
  comment          String?
  
  verifiedPurchase Boolean  @default(false)
  helpfulCount     Int      @default(0)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([productId])
  @@index([userId])
  @@index([rating])
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique // e.g., "Food", "Tech"
  icon        String?   // Store the 3D icon path
  slug        String    @unique // e.g., "food-and-snacks"
  products    Product[]
  description String?
}

// Consolidated Payment Transaction (The "Cart" Checkout)
model OrderGroup {
  id            String   @id @default(uuid())
  paystackRef   String   @unique // The single payment reference covering all orders
  totalAmount   Float    // Grand total paid
  
  studentId     String
  student       User     @relation("StudentOrderGroups", fields: [studentId], references: [id])
  
  orders        Order[]  // The split shipments resulting from this payment
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([paystackRef])
}

model Order {
  id              String      @id @default(uuid())
  
  // Order status tracking
  status          OrderStatus @default(PENDING)
  escrowStatus    EscrowStatus @default(PENDING)
  
  // Link to the parent Group
  orderGroupId    String?
  orderGroup      OrderGroup? @relation(fields: [orderGroupId], references: [id])

  // Subtotal for this specific vendor shipment
  amount          Float
  
  // Items in this shipment
  items           OrderItem[]
  
  studentId       String
  student         User        @relation("StudentOrders", fields: [studentId], references: [id], onDelete: Cascade)
  
  vendorId        String
  vendor          User        @relation("VendorOrders", fields: [vendorId], references: [id], onDelete: Cascade)
  
  // Runner/delivery info
  runnerId        String?
  runner          User?       @relation("RunnerDeliveries", fields: [runnerId], references: [id], onDelete: SetNull)
  runnerEarnings  Float?      // Runner's cut
  runnerXpAwarded Int?        // XP awarded to runner
  
  fulfillmentType FulfillmentType @default(PICKUP)
  
  // Timestamps
  createdAt       DateTime    @default(now())
  paidAt          DateTime?
  pickedUpAt      DateTime?
  deliveredAt     DateTime?

  // Verification Codes
  pickupCode      String?     // 6-digit code for Vendor Hand-off
  releaseKey      String?     // 6-digit Secure Release Key (e.g., 882-104)

  // Relation to Mission
  mission         Mission?
  
  @@index([studentId])
  @@index([vendorId])
  @@index([status])
  @@index([escrowStatus])
}

model OrderItem {
  id        String  @id @default(uuid())
  
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String? // Optional in case product is deleted later? No, keep it.
  product   Product? @relation(fields: [productId], references: [id])
  productSnapshot Json? // Backup title, image, etc.
  
  quantity  Int
  price     Float   // Price at time of purchase
  
  createdAt DateTime @default(now())
  
  @@index([orderId])
  @@index([productId])
}

model Mission {
  id          String   @id @default(cuid())
  
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  runnerId    String?
  runner      User?    @relation(fields: [runnerId], references: [id], onDelete: SetNull)
  
  status      String   @default("PENDING") // PENDING, ASSIGNED, PICKED_UP, DELIVERED
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum FulfillmentType {
  PICKUP
  DELIVERY
}

enum OrderStatus {
  PENDING      // Order created, awaiting payment
  PAID         // Payment received, in escrow
  PREPARING    // Vendor preparing order
  READY        // Ready for pickup/delivery
  PICKED_UP    // Runner picked up (if delivery)
  COMPLETED    // QR scanned, escrow released
  CANCELLED    // Order cancelled
  REFUNDED     // Payment refunded
}

enum EscrowStatus {
  PENDING      // No payment yet
  HELD         // Payment received, held in escrow
  RELEASED     // Released to vendor after QR scan
  REFUNDED     // Refunded to student
}

model Story {
  id          String   @id @default(uuid())
  title       String?
  videoUrl    String
  thumbnail   String?
  vendorId    String
  vendor      User     @relation("VendorStories", fields: [vendorId], references: [id], onDelete: Cascade)
  
  views       Int      @default(0)
  likes       Int      @default(0)
  
  likedBy     StoryLike[] @relation("StoryLikes")
  favoritedBy StoryFavorite[] @relation("StoryFavorites")
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime // Delete/hide after 24h
  
  @@index([vendorId])
}

model StoryLike {
  id        String   @id @default(uuid())
  storyId   String
  story     Story    @relation("StoryLikes", fields: [storyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("UserStoryLikes", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([storyId, userId])
  @@index([storyId])
  @@index([userId])
}

model StoryFavorite {
  id        String   @id @default(uuid())
  storyId   String
  story     Story    @relation("StoryFavorites", fields: [storyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("UserStoryFavorites", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([storyId, userId])
  @@index([storyId])
  @@index([userId])
}



model SystemSettings {
  id              String   @id @default("GLOBAL_CONFIG")
  maintenanceMode Boolean  @default(false)
  activeFeatures  String[] // ["MARKET", "PULSE", "RUNNER", "ESCROW"]
  globalNotice    String?  // "Maintenance until 2:00 PM"
  contentOverride Json?    // Stores live-edited UI text
  
  updatedAt       DateTime @updatedAt
}

model AdminLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())
}

model Feedback {
  id        String   @id @default(cuid())
  userName  String
  userId    String?
  content   String
  rating    Int?
  status    String   @default("OPEN") // OPEN, RESOLVED
  createdAt DateTime @default(now())
}

model VendorApplication {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  shopName  String
  shopDesc  String?  // The "Why"
  location  Json     // {lat, lng, address}
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt DateTime @default(now())

  @@index([status])
}
