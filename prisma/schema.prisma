// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "cockroachdb"
}

model User {
  id           String    @id @default(uuid())
  clerkId      String    @unique
  email        String    @unique
  name         String?
  role         Role      @default(STUDENT)
  university   String?   // e.g., "KNUST", "UG"
  
  // Vendor-specific fields
  shopName       String?
  shopLandmark   String?
  vendorStatus   VendorStatus @default(NOT_APPLICABLE)
  
  // Runner Mode fields
  isRunner     Boolean   @default(false)
  runnerStatus String?   // "IDLE", "DELIVERING"
  xp           Int       @default(0)
  runnerLevel  Int       @default(1)
  
  // Location tracking (hotspot-based)
  currentHotspot String? // e.g., "Balme Library", "Night Market", "Pent Hostel"
  lastActive     DateTime @default(now())
  
  onboarded     Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  products     Product[]
  orders       Order[]   @relation("StudentOrders")
  deliveries   Order[]   @relation("RunnerDeliveries")
  vendorOrders Order[]   @relation("VendorOrders")
  stories      Story[]    @relation("VendorStories")
}

enum Role {
  STUDENT
  VENDOR
  ADMIN
}

enum VendorStatus {
  NOT_APPLICABLE
  PENDING
  ACTIVE
  SUSPENDED
}

model Product {
  id          String   @id @default(uuid())
  title       String
  description String
  price       Float
  category    Category
  imageUrl    String?  // Cloudinary link
  
  // Hotspot-based location for Flash-Match
  hotspot     String?  // e.g., "Bush Canteen", "Balme Library"
  
  vendorId    String
  vendor      User     @relation(fields: [vendorId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  orders      Order[]
}

enum Category {
  FOOD
  BOOK
  LESSON
  SERVICE
}

model Order {
  id              String      @id @default(uuid())
  
  // Order status tracking
  status          OrderStatus @default(PENDING)
  
  // Escrow payment tracking
  escrowStatus    EscrowStatus @default(PENDING)
  paystackRef     String?     @unique // Paystack payment reference

  releaseKey      String?     // The 6-digit Secure Release Key (e.g., 882-104)
  amount          Float
  
  // Product and customer info
  productId       String
  product         Product     @relation(fields: [productId], references: [id])
  
  studentId       String
  student         User        @relation("StudentOrders", fields: [studentId], references: [id])
  
  vendorId        String
  vendor          User        @relation("VendorOrders", fields: [vendorId], references: [id])
  
  // Runner/delivery info
  runnerId        String?
  runner          User?       @relation("RunnerDeliveries", fields: [runnerId], references: [id])
  runnerEarnings  Float?      // Runner's cut
  runnerXpAwarded Int?        // XP awarded to runner
  
  fulfillmentType FulfillmentType @default(PICKUP)
  
  // Timestamps
  createdAt       DateTime    @default(now())
  paidAt          DateTime?
  deliveredAt     DateTime?
  
  @@index([studentId])
  @@index([vendorId])
  @@index([status])
  @@index([escrowStatus])
}

enum FulfillmentType {
  PICKUP
  DELIVERY
}

enum OrderStatus {
  PENDING      // Order created, awaiting payment
  PAID         // Payment received, in escrow
  PREPARING    // Vendor preparing order
  READY        // Ready for pickup/delivery
  PICKED_UP    // Runner picked up (if delivery)
  COMPLETED    // QR scanned, escrow released
  CANCELLED    // Order cancelled
  REFUNDED     // Payment refunded
}

enum EscrowStatus {
  PENDING      // No payment yet
  HELD         // Payment received, held in escrow
  RELEASED     // Released to vendor after QR scan
  REFUNDED     // Refunded to student
}

model Story {
  id          String   @id @default(uuid())
  title       String?
  videoUrl    String
  thumbnail   String?
  vendorId    String
  vendor      User     @relation("VendorStories", fields: [vendorId], references: [id])
  
  views       Int      @default(0)
  likes       Int      @default(0)
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime // Delete/hide after 24h
  
  @@index([vendorId])
}

model SystemConfig {
  id              String   @id @default("GLOBAL_CONFIG")
  deliveryFee     Float    @default(5.0)
  platformFee     Float    @default(2.0)
  maintenanceMode Boolean  @default(false)
  updatedAt       DateTime @updatedAt
}

model AdminLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())
}
