

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "cockroachdb"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  clerkId      String    @unique
  email        String    @unique
  name         String?
  role         Role      @default(STUDENT)
  university   String?   // e.g., "KNUST", "UG"
  
  // Vendor-specific fields
  shopName       String?
  shopLandmark   String?
  vendorStatus   VendorStatus @default(NOT_APPLICABLE)
  isAcceptingOrders Boolean   @default(true)
  
  // Runner Mode fields
  isRunner     Boolean   @default(false)
  runnerStatus String    @default("OFFLINE") // OFFLINE, ONLINE, BUSY
  xp           Int       @default(0)
  runnerLevel  Int       @default(1)
  
  // Location tracking (hotspot-based)
  currentHotspot String? // e.g., "Balme Library", "Night Market", "Pent Hostel"
  lastActive     DateTime @default(now())
  
  onboarded     Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  products     Product[]
  orders       Order[]   @relation("StudentOrders")
  deliveries   Order[]   @relation("RunnerDeliveries")
  vendorOrders Order[]   @relation("VendorOrders")
  stories      Story[]   @relation("VendorStories")
  payoutRequests PayoutRequest[]
  storyLikes   StoryLike[] @relation("UserStoryLikes")
  storyFavorites StoryFavorite[] @relation("UserStoryFavorites")
  missions     Mission[]
  
  // Financials
  balance      Float     @default(0.0)
}

model PayoutRequest {
  id          String   @id @default(uuid())
  amount      Float
  status      String   @default("PENDING") // PENDING, PROCESSED, REJECTED
  momoNumber  String
  network     String   // MTN, VODA, AT
  
  vendorId    String
  vendor      User     @relation(fields: [vendorId], references: [id])
  
  createdAt   DateTime @default(now())
  processedAt DateTime?
  
  @@index([vendorId])
  @@index([status])
}

enum Role {
  STUDENT
  VENDOR
  ADMIN
  GOD_MODE
}

enum VendorStatus {
  NOT_APPLICABLE
  PENDING
  ACTIVE
  SUSPENDED
}

model Product {
  id          String   @id @default(uuid())
  title       String
  description String
  price       Float
  
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  
  details     Json?    // For dynamic fields like "spicyLevel", "condition", etc.

  imageUrl    String?  // Cloudinary link
  
  // Hotspot-based location for Flash-Match
  hotspot     String?  // e.g., "Bush Canteen", "Balme Library"
  
  vendorId    String
  vendor      User     @relation(fields: [vendorId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  orders      Order[]
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique // e.g., "Food", "Tech"
  icon        String?   // Store the 3D icon path
  slug        String    @unique // e.g., "food-and-snacks"
  products    Product[]
  description String?
}

model Order {
  id              String      @id @default(uuid())
  
  // Order status tracking
  status          OrderStatus @default(PENDING)
  
  // Escrow payment tracking
  escrowStatus    EscrowStatus @default(PENDING)
  paystackRef     String?     @unique // Paystack payment reference


  amount          Float
  
  // Product and customer info
  productId       String
  product         Product     @relation(fields: [productId], references: [id])
  
  studentId       String
  student         User        @relation("StudentOrders", fields: [studentId], references: [id])
  
  vendorId        String
  vendor          User        @relation("VendorOrders", fields: [vendorId], references: [id])
  
  // Runner/delivery info
  runnerId        String?
  runner          User?       @relation("RunnerDeliveries", fields: [runnerId], references: [id])
  runnerEarnings  Float?      // Runner's cut
  runnerXpAwarded Int?        // XP awarded to runner
  
  fulfillmentType FulfillmentType @default(PICKUP)
  
  // Timestamps
  createdAt       DateTime    @default(now())
  paidAt          DateTime?
  pickedUpAt      DateTime?
  deliveredAt     DateTime?

  // Verification Codes
  pickupCode      String?     // 6-digit code for Vendor Hand-off
  releaseKey      String?     // The 6-digit Secure Release Key (e.g., 882-104)

  // Relation to Mission
  mission         Mission?
  
  @@index([studentId])
  @@index([vendorId])
  @@index([status])
  @@index([escrowStatus])
}

model Mission {
  id          String   @id @default(cuid())
  
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id])
  
  runnerId    String?
  runner      User?    @relation(fields: [runnerId], references: [id])
  
  status      String   @default("PENDING") // PENDING, ASSIGNED, PICKED_UP, DELIVERED
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum FulfillmentType {
  PICKUP
  DELIVERY
}

enum OrderStatus {
  PENDING      // Order created, awaiting payment
  PAID         // Payment received, in escrow
  PREPARING    // Vendor preparing order
  READY        // Ready for pickup/delivery
  PICKED_UP    // Runner picked up (if delivery)
  COMPLETED    // QR scanned, escrow released
  CANCELLED    // Order cancelled
  REFUNDED     // Payment refunded
}

enum EscrowStatus {
  PENDING      // No payment yet
  HELD         // Payment received, held in escrow
  RELEASED     // Released to vendor after QR scan
  REFUNDED     // Refunded to student
}

model Story {
  id          String   @id @default(uuid())
  title       String?
  videoUrl    String
  thumbnail   String?
  vendorId    String
  vendor      User     @relation("VendorStories", fields: [vendorId], references: [id])
  
  views       Int      @default(0)
  likes       Int      @default(0)
  
  likedBy     StoryLike[] @relation("StoryLikes")
  favoritedBy StoryFavorite[] @relation("StoryFavorites")
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime // Delete/hide after 24h
  
  @@index([vendorId])
}

model StoryLike {
  id        String   @id @default(uuid())
  storyId   String
  story     Story    @relation("StoryLikes", fields: [storyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("UserStoryLikes", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([storyId, userId])
  @@index([storyId])
  @@index([userId])
}

model StoryFavorite {
  id        String   @id @default(uuid())
  storyId   String
  story     Story    @relation("StoryFavorites", fields: [storyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("UserStoryFavorites", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([storyId, userId])
  @@index([storyId])
  @@index([userId])
}



model SystemSettings {
  id              String   @id @default("GLOBAL_CONFIG")
  maintenanceMode Boolean  @default(false)
  activeFeatures  String[] // ["MARKET", "PULSE", "RUNNER", "ESCROW"]
  globalNotice    String?  // "Maintenance until 2:00 PM"
  contentOverride Json?    // Stores live-edited UI text
  
  updatedAt       DateTime @updatedAt
}

model AdminLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())
}
